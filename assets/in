#!/bin/bash

set -e

exec 3>&1
exec 1>&2

destination="$1"

if [ -z "$destination" ]; then
    echo "Error: destination directory not specified" >&2
    exit 1
fi

payload=$(mktemp)
cat > "$payload" <&0

manifest_url=$(jq -r '.source.manifest_url // "https://github.com/zephyrproject-rtos/zephyr"' < "$payload")
manifest_revision=$(jq -r '.source.manifest_revision // "main"' < "$payload")
manifest_path=$(jq -r '.source.manifest_path // "west.yml"' < "$payload")
manifest_sha256=$(jq -r '.version.manifest_sha256 // ""' < "$payload")

echo "Initializing west workspace in $destination"
echo "Manifest URL: $manifest_url"
echo "Manifest revision: $manifest_revision"

mkdir -p "$destination"
cd "$destination"

west init -m "$manifest_url" --mr "$manifest_revision" --mf "$manifest_path" .

echo "Updating west workspace..."
west update

# Retrieve commit info from the manifest project (works for any manifest URL,
# not just zephyr). west config manifest.path gives the path within the workspace
# where the manifest repo was cloned.
manifest_project_path=$(west config manifest.path)
actual_commit=$(cd "$manifest_project_path" && git rev-parse HEAD)
commit_message=$(cd "$manifest_project_path" && git log -1 --pretty=format:"%s")
commit_author=$(cd "$manifest_project_path" && git log -1 --pretty=format:"%an")
commit_date=$(cd "$manifest_project_path" && git log -1 --pretty=format:"%ci")

result=$(jq -n \
    --arg commit "$actual_commit" \
    --arg message "$commit_message" \
    --arg author "$commit_author" \
    --arg date "$commit_date" \
    --arg manifest_url "$manifest_url" \
    --arg manifest_revision "$manifest_revision" \
    --arg manifest_sha256 "$manifest_sha256" \
    '{
        version: {commit: $commit, manifest_sha256: $manifest_sha256},
        metadata: [
            {name: "commit", value: $commit},
            {name: "message", value: $message},
            {name: "author", value: $author},
            {name: "date", value: $date},
            {name: "manifest_url", value: $manifest_url},
            {name: "manifest_revision", value: $manifest_revision},
            {name: "manifest_sha256", value: $manifest_sha256}
        ]
    }')

rm "$payload"

echo "$result" >&3
