#!/bin/bash

set -e

exec 3>&1
exec 1>&2

payload=$(mktemp)
cat > "$payload" <&0

manifest_url=$(jq -r '.source.manifest_url // "https://github.com/zephyrproject-rtos/zephyr"' < "$payload")
manifest_revision=$(jq -r '.source.manifest_revision // "main"' < "$payload")
manifest_path=$(jq -r '.source.manifest_path // "west.yml"' < "$payload")
current_commit=$(jq -r '.version.commit // ""' < "$payload")
current_manifest_sha256=$(jq -r '.version.manifest_sha256 // ""' < "$payload")
rm "$payload"

# Get latest commit from the manifest repo without a full clone
latest_commit=$(git ls-remote "$manifest_url" "refs/heads/$manifest_revision" | cut -f1)

if [ -z "$latest_commit" ]; then
    echo "Error: Could not fetch latest commit from $manifest_url branch $manifest_revision" >&2
    exit 1
fi

# Compute a frozen manifest fingerprint to detect changes in branch-tracked
# dependencies. west manifest --freeze resolves all project revisions (including
# branch names) to their current SHAs by querying each remote, without requiring
# a full west update.
tmpdir=$(mktemp -d)
trap "rm -rf $tmpdir" EXIT

echo "Resolving frozen manifest for $manifest_url @ $manifest_revision..."

# Shallow clone the manifest repo to avoid fetching full history
git clone --depth=1 --branch "$manifest_revision" "$manifest_url" "$tmpdir/manifest"

# Initialize a west workspace from the local clone
west init -m "$tmpdir/manifest" --mf "$manifest_path" "$tmpdir/workspace"

# Freeze the manifest: resolves all project revisions (including branch names) to SHAs.
# The resulting SHA256 changes whenever the manifest repo moves OR whenever any
# branch-tracked dependency gets new commits.
# west manifest --freeze requires branch-tracked projects to be cloned;
# shallow-clone them on demand as reported by west.
freeze_out=$(mktemp)
freeze_err=$(mktemp)
while ! (cd "$tmpdir/workspace" && west manifest --freeze) >"$freeze_out" 2>"$freeze_err"; do
    uncloned=$(sed -n 's/.*cannot freeze; project \([^ ]*\) is uncloned.*/\1/p' "$freeze_err" | head -1)
    if [ -z "$uncloned" ]; then
        cat "$freeze_err" >&2
        rm -f "$freeze_out" "$freeze_err"
        echo "Error: west manifest --freeze failed" >&2
        exit 1
    fi
    echo "Shallow-cloning branch-tracked project for manifest freeze: $uncloned" >&2
    (cd "$tmpdir/workspace" && west update --fetch-opt "--depth=1" "$uncloned")
done
manifest_sha256=$(sha256sum < "$freeze_out" | cut -d' ' -f1)
rm -f "$freeze_out" "$freeze_err"

echo "Manifest commit:  $latest_commit"
echo "Manifest SHA256:  $manifest_sha256"

if [ "$current_commit" = "$latest_commit" ] && \
   [ -n "$current_manifest_sha256" ] && \
   [ "$current_manifest_sha256" != "null" ] && \
   [ "$current_manifest_sha256" = "$manifest_sha256" ]; then
    # Nothing changed
    versions=$(jq -n \
        --arg commit "$current_commit" \
        --arg sha256 "$current_manifest_sha256" \
        '[{commit: $commit, manifest_sha256: $sha256}]')
else
    # New version detected
    versions=$(jq -n \
        --arg commit "$latest_commit" \
        --arg sha256 "$manifest_sha256" \
        '[{commit: $commit, manifest_sha256: $sha256}]')
fi

echo "$versions" >&3
